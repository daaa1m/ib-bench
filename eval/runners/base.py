"""Shared types and utilities for LLM provider runners."""

from dataclasses import dataclass
from pathlib import Path
from typing import Any


def is_content_filter_error(error_str: str) -> bool:
    """Check if an error message indicates a content filter block."""
    error_lower = error_str.lower()
    return (
        (
            "content" in error_lower
            and (
                "policy" in error_lower
                or "blocked" in error_lower
                or "safety" in error_lower
            )
        )
        or "invalid_prompt" in error_lower
        or "invalid prompt" in error_lower
        or "flagged" in error_lower
        or "usage policy" in error_lower
        or "content_policy" in error_lower
        or "moderation" in error_lower
    )


def read_file_content(file_obj) -> bytes:
    """Read content from a file object, handling both stream and bytes."""
    if hasattr(file_obj, "read"):
        return file_obj.read()
    return file_obj


@dataclass
class OutputFile:
    """A file generated by the LLM (e.g., from code execution)."""

    filename: str
    content: bytes
    mime_type: str = "application/octet-stream"


@dataclass
class LLMResponse:
    """Standardized response from any LLM provider."""

    raw_text: str
    parsed_json: dict[str, Any] | None
    model: str
    input_tokens: int
    output_tokens: int
    latency_ms: float
    stop_reason: str = "unknown"
    output_files: list[OutputFile] | None = None


def categorize_input_files(
    files: list[Path],
) -> tuple[list[Path], list[Path]]:
    """
    Categorize input files by the tool they require.

    :param files: List of input file paths
    :returns: (code_interpreter_files, file_search_files)

    Code interpreter: xlsx, xls, csv, png, jpg, jpeg
    File search: pdf
    """
    code_interpreter_exts = {".xlsx", ".xls", ".csv", ".png", ".jpg", ".jpeg"}
    file_search_exts = {".pdf"}

    code_files = []
    search_files = []

    for f in files:
        ext = f.suffix.lower()
        if ext in code_interpreter_exts:
            code_files.append(f)
        elif ext in file_search_exts:
            search_files.append(f)

    return code_files, search_files
